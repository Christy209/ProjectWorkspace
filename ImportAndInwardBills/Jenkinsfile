pipeline {
    agent any

    environment {
        MAVEN_HOME = "C:\\apache-maven-3.9.10\\bin\\mvn"
    }

    stages {

        stage('Init') {
            steps {
                script {
                    echo "üü¢ Selected Branch  : main"
                    echo "üü¢ Selected TestCase: TC01_LodgeTheBillUsingImportandInwardMenu"
                }
            }
        }

        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [],
                    userRemoteConfigs: [[
                        url: 'https://github.com/Christy209/ProjectWorkspace.git'
                    ]]
                ])
            }
        }

        stage('Use Managed Config') {
            steps {
                configFileProvider([configFile(fileId: 'config.properties', variable: 'CONFIG_FILE')]) {
                    script {
                        echo "üìÑ Copying Jenkins Managed config to workspace"
                        
                        // Create TestResult folder if not exists
                        def testResultDir = "${env.WORKSPACE}\\TestResult"
                        if (!fileExists(testResultDir)) {
                            bat "mkdir \"${testResultDir}\""
                        }

                        // Copy config.properties
                        bat "copy /Y \"%CONFIG_FILE%\" \"${testResultDir}\\config.properties\""

                        // Load properties into environment variables
                        def props = readProperties file: "${testResultDir}\\config.properties"
                        env.URL     = props.url
                        env.USERID  = props.userid
                        env.PASS    = props.password
                        env.USERID2 = props.userid2
                        env.PASS2   = props.password2

                        echo """
                        üîπ Loaded Jenkins Managed Config
                        URL     : ${env.URL}
                        USERID  : ${env.USERID}
                        USERID2 : ${env.USERID2}
                        """
                    }
                }
            }
        }

        stage('Edit Config (Optional)') {
            steps {
                script {
                    // Optional: Allow editing config.properties before build
                    echo "‚úèÔ∏è You can manually edit TestResult\\config.properties if needed."
                    echo "üí° This is just informational; manual edits are outside pipeline execution."
                }
            }
        }

        stage('Build') {
            steps {
                script {
                    echo "üî® Running Maven Build..."
                    bat "${MAVEN_HOME} clean install -f %WORKSPACE%\\ImportAndInwardBills\\pom.xml"
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    echo "üß™ Running TestCase: TC01_LodgeTheBillUsingImportandInwardMenu"
                    bat "${MAVEN_HOME} test -f %WORKSPACE%\\ImportAndInwardBills\\pom.xml -Dtest=TC01_LodgeTheBillUsingImportandInwardMenu"
                }
            }
        }

        stage('Post Steps') {
            steps {
                script {
                    echo "‚úÖ Pipeline completed successfully!"
                }
            }
        }
    }

    post {
        success {
            echo "üéâ Build and tests ran successfully!"
        }
        failure {
            echo "‚ùå Pipeline failed. Check logs for details."
        }
    }
}
