pipeline {
    agent any

    environment {
        MAVEN_HOME = "C:\\apache-maven-3.9.10\\bin\\mvn"
    }

    stages {

        stage('Init') {
            steps {
                script {
                    echo "Selected Branch  : main"
                    echo "Selected TestCase: TC01_LodgeTheBillUsingImportandInwardMenu"
                }
            }
        }

        stage('Checkout') {
            steps {
                git url: 'https://github.com/AutoSuit/Payments.git',
                    branch: "main"
            }
        }

        stage('Load Config') {
            steps {
                configFileProvider([configFile(fileId: 'ImportInwardConfig', targetLocation: 'config.properties')]) {
                    script {
                        def props = readProperties file: 'config.properties'

                        env.URL     = props.url
                        env.USERID  = props.userid
                        env.PASS    = props.password
                        env.USERID2 = props.userid2
                        env.PASS2   = props.password2

                        echo "URL: ${env.URL}"
                        echo "USERID: ${env.USERID}"
                        echo "USERID2: ${env.USERID2}"
                    }
                }
            }
        }

        stage('Read Config') {
            steps {
                script {
                    def configPath = 'ImportAndInwardBills/resources/config.properties'
                    echo "Reading config from: ${configPath}"

                    def props = readProperties file: configPath
                    env.DB_URL = props.DB_URL
                    env.DB_USER = props.DB_USER
                    env.DB_PASS = props.DB_PASS

                    echo "DB_URL   : ${env.DB_URL}"
                    echo "DB_USER  : ${env.DB_USER}"
                }
            }
        }

        stage('Build') {
            steps {
                dir('ImportAndInwardBills') {
                    bat "\"${MAVEN_HOME}\" clean install -U"
                }
            }
        }

        stage('Run Selected Tests') {
            steps {
                dir('ImportAndInwardBills') {
                    script {
                        bat 'rmdir /S /Q target\\surefire-reports || exit 0'

                        def testCase = "TC01_LodgeTheBillUsingImportandInwardMenu"

                        bat "\"${MAVEN_HOME}\" clean -Dtest=TestCases.${testCase} test " +
                            "-Ddb.url=${env.DB_URL} -Ddb.user=${env.DB_USER} -Ddb.pass=${env.DB_PASS}"
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                // SAFE JUNIT
                def reportFiles = findFiles(glob: 'ImportAndInwardBills/target/surefire-reports/*.xml')

                if (reportFiles.length > 0) {
                    junit(
                        testResults: 'ImportAndInwardBills/target/surefire-reports/*.xml',
                        allowEmptyResults: true,
                        skipMarkingBuildUnstable: true,
                        keepLongStdio: true
                    )
                } else {
                    echo "‚ö† No test XML reports found, skipping JUnit publishing"
                }

                // Archive
                archiveArtifacts artifacts: 'ImportAndInwardBills/target/surefire-reports/**', fingerprint: true
            }
        }

        success {
            echo "üéâ Build PASSED"
        }

        failure {
            echo "‚ùå Build FAILED"
        }
    }
}
