pipeline {
    agent any

    environment {
        MAVEN_HOME = "C:\\apache-maven-3.9.10\\bin\\mvn"
        BACKEND_URL = "http://localhost:4000" // Your manually started backend
    }

    stages {

        stage('Init') {
            steps {
                script {
                    echo "üü¢ Selected Branch  : main"
                    echo "üü¢ Selected TestCase: TC01_LodgeTheBillUsingImportandInwardMenu"
                }
            }
        }

        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [],
                    userRemoteConfigs: [[
                        url: 'https://github.com/Christy209/ProjectWorkspace.git'
                    ]]
                ])
            }
        }

        stage('Fetch Config from Backend') {
            steps {
                script {
                    echo "üìÑ Fetching config.properties from backend at ${env.BACKEND_URL}"

                    def testResultDir = "${env.WORKSPACE}\\TestResult"
                    if (!fileExists(testResultDir)) {
                        bat "mkdir \"${testResultDir}\""
                    }

                    // Fetch config from running backend
                    def configContent = bat(
                        script: "curl -s ${env.BACKEND_URL}/config",
                        returnStdout: true
                    ).trim()

                    writeFile file: "${testResultDir}\\config.properties", text: configContent

                    echo "üîπ Config fetched and saved to TestResult\\config.properties"
                }
            }
        }

        stage('Build') {
            steps {
                script {
                    echo "üî® Running Maven Build..."
                    bat "${MAVEN_HOME} clean install -f %WORKSPACE%\\ImportAndInwardBills\\pom.xml"
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    echo "üß™ Running TestCase: TC01_LodgeTheBillUsingImportandInwardMenu"
                    bat "${MAVEN_HOME} test -f %WORKSPACE%\\ImportAndInwardBills\\pom.xml -Dtest=TC01_LodgeTheBillUsingImportandInwardMenu"
                }
            }
        }

        stage('Update Config Back to Backend (Optional)') {
            steps {
                script {
                    echo "üîÑ Updating config.properties back to backend (optional)"

                    def updatedContent = readFile("${env.WORKSPACE}\\TestResult\\config.properties")
                    def escapedContent = updatedContent.replaceAll('"', '\\"')

                    bat """
                    curl -X POST -H "Content-Type: application/json" -d "{\\"content\\": \\"${escapedContent}\\", \\"secret\\": \\"CHRISTY_EDIT\\"}" ${env.BACKEND_URL}/config
                    """
                }
            }
        }

        stage('Post Steps') {
            steps {
                script {
                    echo "‚úÖ Pipeline completed successfully!"
                }
            }
        }
    }

    post {
        success {
            echo "üéâ Build and tests ran successfully!"
        }
        failure {
            echo "‚ùå Pipeline failed. Check logs for details."
        }
    }
}
