pipeline {
    agent any

    environment {
        // Set Maven home
        MAVEN_HOME = "C:\\apache-maven-3.9.10\\bin\\mvn"
    }

    stages {

        stage('Init') {
            steps {
                script {
                    echo "üü¢ Selected Branch  : main"
                    echo "üü¢ Selected TestCase: TC01_LodgeTheBillUsingImportandInwardMenu"
                }
            }
        }

        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [],
                    userRemoteConfigs: [[
                        url: 'https://github.com/Christy209/ProjectWorkspace.git'
                    ]]
                ])
            }
        }

        stage('Use Managed Config') {
            steps {
                configFileProvider([configFile(fileId: 'config.properties', variable: 'CONFIG_FILE')]) {
                    script {
                        echo "üìÑ Copying Jenkins Managed config to workspace"
                        bat "mkdir \"%WORKSPACE%\\TestResult\""
                        bat "copy /Y \"%CONFIG_FILE%\" \"%WORKSPACE%\\TestResult\\config.properties\""

                        // Read properties
                        def props = readProperties file: "%WORKSPACE%\\TestResult\\config.properties"
                        env.URL     = props.url
                        env.USERID  = props.userid
                        env.PASS    = props.password
                        env.USERID2 = props.userid2
                        env.PASS2   = props.password2

                        // Display properties in console
                        echo "üìå Loaded Jenkins Managed Config:"
                        props.each { key, value ->
                            echo "${key} = ${value}"
                        }
                    }
                }
            }
        }

        stage('Edit Config (Optional)') {
            steps {
                script {
                    // Example: dynamically update config.properties in workspace
                    def propsFile = "%WORKSPACE%\\TestResult\\config.properties"
                    writeFile file: propsFile, text: """
                    url=${env.URL}
                    userid=${env.USERID}
                    password=${env.PASS}
                    userid2=${env.USERID2}
                    password2=${env.PASS2}
                    """
                    echo "‚úèÔ∏è Updated config.properties (if needed) in workspace:"
                    def updatedProps = readProperties file: propsFile
                    updatedProps.each { key, value ->
                        echo "${key} = ${value}"
                    }
                }
            }
        }

        stage('Build') {
            steps {
                script {
                    echo "üî® Running Maven Build..."
                    bat "${MAVEN_HOME} clean install -f %WORKSPACE%\\ImportAndInwardBills\\pom.xml"
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    echo "üß™ Running TestCase: TC01_LodgeTheBillUsingImportandInwardMenu"
                    bat "${MAVEN_HOME} test -f %WORKSPACE%\\ImportAndInwardBills\\pom.xml -Dtest=TC01_LodgeTheBillUsingImportandInwardMenu"
                }
            }
        }

        stage('Post Steps') {
            steps {
                script {
                    echo "‚úÖ Pipeline completed successfully!"
                }
            }
        }
    }

    post {
        success {
            echo "üéâ Build and tests ran successfully!"
        }
        failure {
            echo "‚ùå Pipeline failed. Check logs for details."
        }
    }
}
